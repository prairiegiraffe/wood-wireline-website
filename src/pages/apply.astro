---
import Layout from '~/layouts/PageLayout.astro';
import Hero from '~/components/widgets/Hero.astro';
import Image from '~/components/common/Image.astro';
import TablerIcon from '~/components/ui/TablerIcon.astro';

const metadata = {
  title: 'Apply - Wood Wireline',
};
---

<Layout metadata={metadata}>
  <!-- Hero Section ******************* -->

  <Hero
    actions={[
      { variant: 'primary', text: 'Call HR', href: 'tel:307-682-0143', icon: 'tabler:phone' },
      { variant: 'secondary', text: 'View Locations', href: '/contact/#map' },
    ]}
  >
    <Fragment slot="title">
      <span class="text-gray-900 dark:text-white">JOIN OUR TEAM</span><br />
      <span class="text-gray-900 dark:text-white text-2xl md:text-3xl font-normal mt-4 block"
        >Build Your Career With Us</span
      >
    </Fragment>

    <Fragment slot="bg">
      <Image
        src="~/assets/images/All Images/Oilfield Workers Onsite.webp"
        alt="Wood Wireline Careers"
        class="absolute inset-0 w-full h-full object-cover opacity-50 dark:opacity-30"
        widths={[1920, 2560]}
        sizes="100vw"
        style="min-width: 100%; width: 100%; height: 100%; object-fit: cover;"
      />
      <div class="absolute inset-0 bg-gradient-to-b from-black/42 via-black/30 to-black/42"></div>
    </Fragment>
  </Hero>

  <!-- Application Form Section ******************* -->

  <section class="py-16 md:py-24 bg-white dark:bg-gray-800">
    <div class="max-w-4xl mx-auto px-4 sm:px-6">
      <div class="text-center mb-12">
        <p class="text-base font-semibold text-secondary dark:text-blue-200 uppercase tracking-wide mb-2">
          Employment Application
        </p>
        <h2 class="text-3xl md:text-4xl font-bold tracking-tight dark:text-white mb-4">Apply Today</h2>
        <p class="text-lg text-muted dark:text-slate-300">
          Complete the form below to apply for a position with Wood Wireline. We're always looking for skilled,
          safety-minded professionals to join our team.
        </p>
      </div>

      <!-- Application Form -->
      <form
        class="bg-gray-50 dark:bg-gray-900 rounded-xl p-6 md:p-8 shadow-lg border border-gray-200 dark:border-gray-700"
        id="applicationForm"
      >
        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <!-- Name -->
          <div>
            <label for="name" class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
              Full Name <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
              placeholder="John Smith"
            />
          </div>

          <!-- Phone -->
          <div>
            <label for="phone" class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
              Phone Number <span class="text-red-500">*</span>
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              required
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
              placeholder="307-555-1234"
            />
          </div>

          <!-- Email -->
          <div>
            <label for="email" class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
              Email Address <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
              placeholder="john.smith@email.com"
            />
          </div>

          <!-- Date of Birth -->
          <div>
            <label for="dob" class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
              Date of Birth <span class="text-red-500">*</span>
            </label>
            <input
              type="date"
              id="dob"
              name="dob"
              required
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
            />
          </div>

          <!-- Preferred Location -->
          <div>
            <label for="location" class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
              Preferred Location <span class="text-red-500">*</span>
            </label>
            <select
              id="location"
              name="location"
              required
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
            >
              <option value="">Select a location</option>
              <option value="gillette">Gillette, WY (HQ)</option>
              <option value="casper">Casper, WY</option>
              <option value="dickinson">Dickinson, ND</option>
              <option value="williston">Williston, ND</option>
              <option value="any">Any Location</option>
            </select>
          </div>

          <!-- Experience -->
          <div>
            <label for="experience" class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
              Industry Experience <span class="text-red-500">*</span>
            </label>
            <select
              id="experience"
              name="experience"
              required
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
            >
              <option value="">Select experience level</option>
              <option value="none">No Experience</option>
              <option value="1-3">1-3 Years</option>
              <option value="3-5">3-5 Years</option>
              <option value="5+">5+ Years</option>
            </select>
          </div>

          <!-- Driver's License Type -->
          <div>
            <label for="cdl" class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
              Driver's License Type <span class="text-red-500">*</span>
            </label>
            <select
              id="cdl"
              name="cdl"
              required
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
            >
              <option value="">Select license type</option>
              <option value="class-a">Class A CDL</option>
              <option value="class-b">Class B CDL</option>
              <option value="standard">Standard Driver's License</option>
              <option value="none">No Driver's License</option>
            </select>
          </div>

          <!-- Resume Upload -->
          <div>
            <label for="resume" class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
              Resume/CV <span class="text-red-500">*</span>
            </label>
            <input
              type="file"
              id="resume"
              name="resume"
              accept=".pdf,.doc,.docx"
              required
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-primary/90"
            />
            <p class="text-xs text-muted dark:text-slate-400 mt-1">Accepted formats: PDF, DOC, DOCX (Max 5MB)</p>
          </div>
        </div>

        <!-- Screening Requirements Info -->
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
          <h3 class="flex items-center gap-2 text-sm font-semibold text-gray-900 dark:text-white mb-2">
            <TablerIcon name="tabler:info-circle" className="w-5 h-5 text-primary" />
            Employment Screening Requirements
          </h3>
          <ul class="text-sm text-muted dark:text-slate-300 space-y-1 ml-7">
            <li>• No felony convictions</li>
            <li>• No DUI convictions within the last 3 years</li>
            <li>• Must pass ATF background check</li>
            <li>• Must pass pre-employment drug screening</li>
          </ul>
        </div>

        <!-- Submit Button -->
        <div class="flex flex-col sm:flex-row gap-4">
          <button type="submit" class="btn-primary w-full sm:w-auto inline-flex items-center justify-center px-8 py-3">
            <TablerIcon name="tabler:send" className="w-5 h-5 mr-2" />
            Submit Application
          </button>
          <button type="reset" class="btn-secondary w-full sm:w-auto inline-flex items-center justify-center px-8 py-3">
            Clear Form
          </button>
        </div>
      </form>
    </div>
  </section>

  <!-- Why Work Here Section ******************* -->

  <section class="py-16 md:py-24 bg-gray-50 dark:bg-gray-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold tracking-tight dark:text-white mb-4">Why Work at Wood Wireline?</h2>
        <p class="text-lg text-muted dark:text-slate-300 max-w-3xl mx-auto">
          Join a team with nearly five decades of industry leadership and a commitment to excellence.
        </p>
      </div>

      <div class="grid md:grid-cols-3 gap-8">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-700">
          <div class="w-12 h-12 rounded-lg bg-primary/10 flex items-center justify-center mb-4">
            <TablerIcon name="tabler:shield-check" className="w-6 h-6 text-primary" />
          </div>
          <h3 class="text-xl font-bold dark:text-white mb-2">Safety First</h3>
          <p class="text-muted dark:text-slate-400">
            We prioritize safety in every operation. Comprehensive training and strict protocols keep our team safe.
          </p>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-700">
          <div class="w-12 h-12 rounded-lg bg-secondary/10 flex items-center justify-center mb-4">
            <TablerIcon name="tabler:trending-up" className="w-6 h-6 text-secondary" />
          </div>
          <h3 class="text-xl font-bold dark:text-white mb-2">Career Growth</h3>
          <p class="text-muted dark:text-slate-400">
            Opportunities for advancement and professional development. We invest in our people.
          </p>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-700">
          <div class="w-12 h-12 rounded-lg bg-primary/10 flex items-center justify-center mb-4">
            <TablerIcon name="tabler:users" className="w-6 h-6 text-primary" />
          </div>
          <h3 class="text-xl font-bold dark:text-white mb-2">Strong Team</h3>
          <p class="text-muted dark:text-slate-400">
            Work alongside experienced professionals in a supportive environment. Low turnover, high morale.
          </p>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  const form = document.getElementById('applicationForm') as HTMLFormElement | null;

  async function submitApplication(form: HTMLFormElement) {
    const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    const originalButtonText = submitButton?.textContent || 'Submit Application';

    try {
      // Disable button and show loading state
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Submitting...';
      }

      // Get form data
      const formData = new FormData(form);
      const resumeFile = formData.get('resume') as File;

      // Convert resume to base64 if it exists
      let resumeData: { filename: string; content: string; type: string; size: number } | null = null;
      if (resumeFile && resumeFile.size > 0) {
        const base64 = await fileToBase64(resumeFile);
        resumeData = {
          filename: resumeFile.name,
          content: base64,
          type: resumeFile.type,
          size: resumeFile.size,
        };
      }

      // Build submission data
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      const data: Record<string, any> = {};
      formData.forEach((value, key) => {
        if (key !== 'resume') {
          data[key] = value.toString();
        }
      });

      // Add metadata
      data.resume = resumeData;
      data.formType = 'careers';
      data.timestamp = new Date().toISOString();
      data.source = 'Wood Wireline Application Form';
      data.page_url = window.location.href;

      // Get webhook URL from environment variable
      const webhookUrl = import.meta.env.PUBLIC_MAKE_WEBHOOK_URL;

      if (!webhookUrl) {
        throw new Error('Webhook URL not configured');
      }

      // Send to Make.com
      const response = await fetch(webhookUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Failed to submit application');
      }

      // Success!
      alert(
        'Thank you for your application!\n\nWe have received your submission and will review it carefully. If your qualifications match our current openings, we will contact you to schedule an interview.\n\nFor immediate inquiries, please call us at 307-682-0143.'
      );
      form.reset();
    } catch (error) {
      console.error('Application submission error:', error);
      alert(
        'There was an error submitting your application. Please try again or email your resume to careers@woodwireline.com or call us at 307-682-0143.'
      );
    } finally {
      // Re-enable button
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.textContent = originalButtonText;
      }
    }
  }

  function fileToBase64(file: File): Promise<string> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => {
        const result = reader.result as string;
        // Remove the data:*/*;base64, prefix
        const base64 = result.split(',')[1];
        resolve(base64);
      };
      reader.onerror = (error) => reject(error);
    });
  }

  if (form) {
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      submitApplication(form);
    });
  }
</script>
